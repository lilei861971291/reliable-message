<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.reliable.message.server.dao.ServerMessageMapper">



    <resultMap id="RM_ServerMessageData" type="com.reliable.message.server.domain.ServerMessageData">
        <result property="id" column="id"/>
        <result property="version" column="version"/>
        <result property="messageKey" column="message_key"/>
        <result property="messageTopic" column="message_topic"/>
        <result property="messageBody" column="message_body"/>
        <result property="messageType" column="message_type"/>
        <result property="producerGroup" column="producer_group"/>
        <result property="producerMessageId" column="producer_message_id" />
        <result property="delayLevel" column="delay_level"/>
        <result property="orderType" column="order_type"/>
        <result property="status" column="status"/>
        <result property="taskStatus" column="task_status"/>
        <result property="updateTime" column="update_time"/>
        <result property="resendTimes" column="resend_times"/>
        <result property="dead" column="dead"/>
        <result property="nextExeTime" column="next_exe_time"/>
        <result property="yn" column="yn"/>
        <result property="creator" column="creator"/>
        <result property="creatorId" column="creator_id"/>
        <result property="createdTime" column="created_time"/>
        <result property="lastOperator" column="last_operator"/>
        <result property="lastOperatorId" column="last_operator_id"/>
    </resultMap>


    <sql id="columns">
        <![CDATA[
		id,version,message_key,message_topic,message_tag,message_body,message_type,producer_group,delay_level,order_type,status,task_status,update_time,resend_times,dead,next_exe_time,yn,creator,creator_id,created_time,last_operator,last_operator_id
	    ]]>
    </sql>


    <sql id="update_sql">
        <set>
            <if test="version != null">
                version = #{version} ,
            </if>
            <if test="messageKey != null and messageKey != ''">
                message_key = #{messageKey} ,
            </if>
            <if test="messageTopic != null and messageTopic != ''">
                message_topic = #{messageTopic} ,
            </if>

            <if test="messageBody != null and messageBody != ''">
                message_body = #{messageBody} ,
            </if>

            <if test="producerGroup != null and producerGroup != ''">
                producer_group = #{producerGroup} ,
            </if>

            <if test="status != null">
                status = #{status} ,
            </if>

            <if test="updateTime != null">
                update_time = #{updateTime} ,
            </if>
            <if test="sendTimes != null">
                send_times = #{sendTimes} ,
            </if>
            <if test="dead != null">
                dead = #{dead} ,
            </if>

            <if test="createTime != null">
                create_time = #{createTime}
            </if>
        </set>
    </sql>


    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        <![CDATA[
	        INSERT INTO message (
	        	id ,
	        	version ,
	        	message_topic ,
	        	message_body ,
	        	message_key,
	        	producer_message_id,
	        	producer_group ,
	        	status ,
	        	update_time ,
	        	send_times ,
	        	dead ,
	        	create_time
	        ) VALUES (
	        	#{id} ,
	        	#{version} ,
	        	#{messageTopic} ,
	        	#{messageBody} ,
	        	#{messageKey},
	        	#{producerMessageId} ,
	        	#{producerGroup} ,
	        	#{status} ,
	        	#{updateTime} ,
	        	#{sendTimes} ,
	        	#{dead} ,
	        	#{createTime}
	        )
	    ]]>
    </insert>


    <select id="getByProducerMessageId" parameterType="java.lang.String" resultMap="RM_ServerMessageData" >
            SELECT * FROM message WHERE producer_message_id = #{producerMessageId}
    </select>
    
    <update id="updateById" parameterType="com.reliable.message.server.domain.ServerMessageData"  >
        UPDATE message
        <include refid="update_sql" />
        WHERE
        id = #{id}
    </update>



    <select id="getServerMessageDataByParams" parameterType="com.alibaba.fastjson.JSONObject" resultMap="RM_ServerMessageData" >
        SELECT * FROM message WHERE status = #{status} AND create_time &lt; #{clearTime}
        AND MOD(id, #{shardingTotalCount}) = #{shardingItem} Limit 0, #{fetchNum}
    </select>


    <delete id="deleteServerMessageDataById" parameterType="java.lang.Long" >
        DELETE FROM message where id = #{id}
    </delete>


    <select id="getWaitConfirmServerMessageData" parameterType="com.alibaba.fastjson.JSONObject" resultMap="RM_ServerMessageData" >
        SELECT * FROM message WHERE status = 10 AND create_time &lt; DATE_SUB(CURRENT_TIMESTAMP(),INTERVAL 1 MINUTE)
        AND MOD(id, #{shardingTotalCount}) = #{shardingItem} Limit 0, #{fetchNum}
    </select>

</mapper>