<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.reliable.message.client.dao.ClientMessageDataMapper">


	<resultMap id="RM_ClientMessageData" type="com.reliable.message.model.domain.ClientMessageData">
		<result property="id" column="id"/>
		<result property="version" column="version"/>
		<result property="messageKey" column="message_key"/>
		<result property="messageTopic" column="message_topic"/>
		<result property="messageBody" column="message_body"/>
		<result property="messageType" column="message_type"/>
		<result property="producerMessageId" column="producer_message_id" />
		<result property="delayLevel" column="delay_level"/>
		<result property="status" column="status"/>
		<result property="updateTime" column="update_time"/>
		<result property="creator" column="creator"/>
		<result property="creatorId" column="creator_id"/>
		<result property="createdTime" column="created_time"/>
		<result property="lastOperator" column="last_operator"/>
		<result property="lastOperatorId" column="last_operator_id"/>
	</resultMap>

	<insert id="insert" parameterType="com.reliable.message.model.domain.ClientMessageData" >
		INSERT INTO client_message_data (
				id ,
				version ,
				message_key ,
				message_topic ,
				message_type ,
				message_body ,
				producer_message_id ,
				delay_level ,
				status ,
				creator ,
				creator_id ,
				created_time ,
				last_operator ,
				last_operator_id ,
				update_time
			) VALUES (
				#{id} ,
				#{version} ,
				#{messageKey} ,
				#{messageTopic} ,
				#{messageType} ,
				#{messageBody} ,
				#{producerMessageId} ,
				#{delayLevel} ,
				#{status} ,
				#{creator} ,
				#{creatorId} ,
				#{createdTime} ,
				#{lastOperator} ,
				#{lastOperatorId} ,
				#{updateTime}
			)
	</insert>


	<select id="getClientMessageByMessageIdAndType" resultMap="RM_ClientMessageData">
		  SELECT * FROM client_message_data WHERE id = #{messageId} and message_type = #{messageType}
	</select>

	<delete id="deleteMessageByProducerMessageId" parameterType="java.lang.String" >
		DELETE FROM client_message_data WHERE producer_message_id = #{producerMessageId}
	</delete>


	<select id="getClientMessageByParams" parameterType="com.alibaba.fastjson.JSONObject" resultMap="RM_ClientMessageData">
		  SELECT * FROM client_message_data WHERE message_type=#{messageType} AND created_time &lt;  DATE_SUB(CURDATE(),INTERVAL 1 DAY)
		  AND MOD(id, #{shardingTotalCount}) = #{shardingItem} Limit 0, #{fetchNum}
	</select>
</mapper>